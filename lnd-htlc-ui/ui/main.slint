import { Button, LineEdit, ScrollView, VerticalBox } from "std-widgets.slint";
import { Invoice, InvoiceItem } from "components/invoice.slint";
import { WalletUnlockDialog } from "components/wallet_dialog.slint";
import { ActionButton } from "components/action_button.slint";
import { AppLayout } from "components/app_layout.slint";
import { ChannelsView, Channel, PendingChannel } from "views/channels_view.slint";
import { CreateCustomInvoiceView, PayInvoiceView, ClaimInvoiceView, CreateStandardInvoiceView } from "views/create_invoice_view.slint";
import { WelcomeView } from "views/welcome_view.slint";
import { CreateChannelView } from "views/create_channel_view.slint";
import { Sidebar } from "components/sidebar.slint";
import { InvoicesView, InvoiceDetails } from "views/invoices_view.slint";

export enum ActivePage {
    XhPanel,
    InvoicePanel,
    PaymentPanel,
    ClaimPanel,
    StandardInvoicePanel,
}

export component MainWindow inherits Window {
    title: "Lightning Network - HTLC Explorer";
    width: 1000px;
    height: 680px;
    background: #222222;
    
    // Properties settable by the application
    in property <bool> node-is-running: false;
    in property <string> node-sync-status: "unknown";
    in property <bool> wallet-needs-unlock: false;
    in property <bool> litd-started-by-app: false;
    in property <string> status-message: "";
    in property <bool> status-checking: false;
    in property <[Channel]> channels: [];
    in property <[PendingChannel]> pending_channels: [];
    
    // Callbacks
    callback manage-channels();
    callback request-preimage-generation();
    callback connect-peer(string, string, string); // pubkey, host, port
    callback create-custom-invoice(string, string, string, string); // preimage_x, preimage_h, amount, memo
    callback pay-custom-invoice(string); // bolt11
    callback claim-custom-invoice(string, string); // hash, preimage
    callback create-standard-invoice(string, int); // memo, amount
    callback open-lightning-channel(); // pubkey, amount (New callback for opening channel)
    callback manage-invoices(); // New callback for listing invoices
    callback settle-custom-invoice(string); // preimage_x

    // Action page tracking
    in-out property <int> active-page: -1; // 0 = manage channels, 1 = create channel, 2 = generate x/h, 3 = custom invoice, 4 = pay invoice, 5 = claim invoice, 6 = standard invoice
    
    in property <bool> has-error: false;
    
    // Local storage for preimage and hash
    property <string> current-preimage;
    property <string> current-hash;
    
    // Properties for CreateChannelView
    in-out property <string> create-channel-status-message: "";
    in-out property <string> create-channel-funding-txid: "";
    in-out property <bool> create-channel-in-progress: false;
    
    // Property to hold all invoices
    in-out property <[InvoiceDetails]> all_invoices: [];

    // Properties to hold generated preimage and hash
    in-out property <string> generated_preimage_x: "";
    in-out property <string> generated_preimage_h: "";
    in-out property <string> payment_address: "";
    
    // Main app layout with sidebar and status bar
    AppLayout {
        node-is-running: root.node-is-running;
        node-sync-status: root.node-sync-status;
        wallet-needs-unlock: root.wallet-needs-unlock;
        status-message: root.status-message;
        has-error: root.has-error;
        litd-started-by-app: root.litd-started-by-app;
        status-checking: root.status-checking;
        channels: root.channels;
        pending-channels: root.pending_channels;
        active-page <=> root.active-page;
        
        home => { root.active-page = -1; }
        manage-channels => { root.manage-channels(); }
        create-channel => { 
            root.active-page = 1; 
            root.create-channel-status-message = ""; // Reset status when navigating to page
            root.create-channel-funding-txid = "";
            root.create-channel-in-progress = false;
        }
        request-preimage-generation => { root.request-preimage-generation(); }
        manage-invoices => { root.manage-invoices(); }
        create-custom-invoice => { root.active-page = 3; }
        pay-invoice => { root.active-page = 4; }
        claim-invoice => { root.active-page = 5; }
        create-standard-invoice => { root.active-page = 6; }

        // Main content area based on active page
        if (active-page == -1): WelcomeView {
            node-is-running: root.node-is-running;
            node-sync-status: root.node-sync-status;
        }
        
        if (active-page == 0): ChannelsView {
            channels: root.channels;
            pending_channels: root.pending_channels;
        }
        
        if (active-page == 1): CreateChannelView {
            status-message <=> root.create-channel-status-message;
            funding-txid <=> root.create-channel-funding-txid;
            operation-in-progress <=> root.create-channel-in-progress;
            open-channel-requested() => {
                root.create-channel-in-progress = true;
                root.open-lightning-channel();
            }
        }

        if (active-page == 2): InvoicesView {
            invoices <=> root.all_invoices;
            settle-custom-invoice(r_hash) => { root.settle-custom-invoice(r_hash); }
        }
        
        if (active-page == 3): CreateCustomInvoiceView {
            create-clicked(preimage_x, preimage_h, amount, memo) => {
                root.create-custom-invoice(preimage_x, preimage_h, amount, memo);
            }
            request-preimage-generation => {
                root.request-preimage-generation();
            }
            generated-preimage-x <=> root.generated_preimage_x;
            generated-preimage-h <=> root.generated_preimage_h;
            payment-address <=> root.payment_address;
        }
        
        if (active-page == 4): PayInvoiceView {
            pay-clicked(bolt11) => {
                root.pay-custom-invoice(bolt11);
            }
        }
        
        if (active-page == 5): ClaimInvoiceView {
            claim-clicked(hash, preimage) => {
                root.claim-custom-invoice(hash, preimage);
            }
        }
        
        if (active-page == 6): CreateStandardInvoiceView {
            create-clicked(memo, amount) => {
                root.create-standard-invoice(memo, amount);
            }
        }
    }
} 